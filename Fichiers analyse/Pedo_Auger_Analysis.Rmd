---
title: "pedo_Auger_Analysis"
author: "EmilieSanvito"
date: "2023-10-05"
output: html_document
---
###Pedologie projet

##data organization

```{r libraries}
#to empty your work environment
rm(list=ls()) 


library(tidyverse)
library(readxl)
library(dplyr)

library(ggforce)   #look again why I used it
library(knitr)

library(car)  #for anvoa
library(ggfortify)   #for autoplot function

```

```{r upload and structure data}
#import data from last year project (36 Auger in the P16)
dataAuger2022 <- read_excel("DataAuger2022.xlsx", na = "NA")  

#create a new column for topography that only contains the number of the topography 
dataAuger2022$topo <- as.numeric(gsub("[^0-9]+", "", dataAuger2022$topographie))
#6: bas fonds
#5: versant bas de pente
#4: versant mi-pente
#3: versant haut de pente
#2: ...?
#1: plateau

#import botany data
Botany <- read_excel("DataAuger2022.xlsx", na = "NA", sheet = "Data Giacomo")  

#remove NA objects
Botany <- Botany %>% 
  na.omit  

#make a more precise df with variables we will use
Botany <- Botany %>% 
  select(c("TreeID", "Family", "Genus", "species", "DBH", "Xutm", "Yutm"))

```

```{r rename titles in data}

dataAuger2022 <- dataAuger2022 %>% rename_at('% pente', ~'pente')
dataAuger2022 <- dataAuger2022 %>% rename_at('Numéro horizon', ~'horizon')
dataAuger2022 <- dataAuger2022 %>% rename_at('profondeur limite inférieure (cm)2', ~'depth_inf')
dataAuger2022 <- dataAuger2022 %>% rename_at('profondeur limite supérieure (cm)', ~'depth_sup')
dataAuger2022 <- dataAuger2022 %>% rename_at('Epaisseur (cm)', ~'epaisseur')
dataAuger2022 <- dataAuger2022 %>% rename_at('Texture corrigée 2023', ~'Texture_2023')
dataAuger2022 <- dataAuger2022 %>% rename_at('EG %', ~'stone_elements')
dataAuger2022 <- dataAuger2022 %>% rename_at('Réserve eau utile (mm) NEW...35', ~'water_reservoir')

```


We have 36 Auger points, of which some do not have corrected texture analysis so we do not consider these (22) and of these 22 there are 17 that are on the slope. Of these 17 only 13 have high silt class present in their texture data.

Of the 22 texture available, there are 16 that have high texture present


## check for correlation between topography and high silt depth occurences

```{r part for correlation test}
#create a cleaner dataframe with only necessary informations
Auger_cor <- dataAuger2022 %>% 
  select(c("sondage_N", "depth_sup", "texture", "Texture_2023", "topo", "arbre_plus_proche"))

#create new texture variable that contains some non-corrected textures
Auger_cor$final_texture <- ifelse(
  is.na(dataAuger2022$Texture_2023) & !(dataAuger2022$sondage_N %in% c("15.1", "15.2", "15.5", "15.7", "19.5", "19.7", "20.5")),
  dataAuger2022$texture,
  dataAuger2022$Texture_2023
)

#create dataframe with only final texture as texture, and then only eliminate the rows for which we have not data of
Auger_cor <- Auger_cor %>%
  select(c("sondage_N", "depth_sup", "final_texture", "topo", "arbre_plus_proche")) %>%
  na.omit

#create new column with textures divided in three classes based upon their presence of silt
Auger_cor$Silt_class <- ifelse(Auger_cor$final_texture %in% c("A", "Alo", "AS"), "low", ifelse(Auger_cor$final_texture %in% c("SL", "SA", "S"), "intermediate", "high"))

#creata dataframe in which for every Auger point you have defined depth at which silt concentration becomes high, or if intermediate that it is 100 (!!Important to check this)
Auger_cor <- Auger_cor %>%
  group_by(sondage_N) %>%
  mutate(
    final_depth = ifelse(any(Silt_class == "high"), 
                         min(depth_sup[Silt_class == "high"]), 
                         100)
  ) %>%
  ungroup() %>%
  distinct(sondage_N, .keep_all = TRUE) %>%
  select(sondage_N, final_depth, topo, arbre_plus_proche)

#import elevation data of topography
Elevation <- read.csv("Elevation_exact.csv")

#merge two dataframes 
Elevation <- Elevation %>%
  select(c("sondage_N", "Elevation_Paracou_depth1")) %>%
  merge(Auger_cor, by.x = 'sondage_N', by.y = 'sondage_N')

#correlation test between topography and high silt depth appearance, spearman method instead of pearson due to non-normality (of final depth because much more values of no HSD appearance)
cor(Elevation$Elevation_Paracou_depth1, Elevation$final_depth, method = "spearman")

cor.test(Elevation$Elevation_Paracou_depth1, Elevation$final_depth, method = 
c("spearman"))

```
There is a correlation of - 0.634 between the topography and the depth at which silt occurs in high levels. This means that with higher elevation silt appears quicker in high concentrations (depth gets smaller).

=> this causes multicollinearity in our model
the effects of multicollinearity are that the predictions are way less precise and can quickly completely change of direction/relationship.     

```{r little data visualisation for correlation}
hist(Elevation$final_depth)
hist(Elevation$Elevation_Paracou_depth1)

ggplot(Elevation, aes(x=as.factor(topo), y=final_depth)) + geom_boxplot() + geom_point()

ggplot(Elevation, aes(x=Elevation_Paracou_depth1, y=final_depth)) + geom_point() + geom_smooth(method = "lm")

#create graph without augers that do not have high silt occurences (they are all attributed 100 for analyses purposes)
ggplot(Elevation, aes(x = Elevation_Paracou_depth1, y = final_depth)) +
  geom_point(data = subset(Elevation, final_depth != 100)) +
  geom_smooth(data = subset(Elevation, final_depth != 100), method = "lm")

```

Assumptions for correlation test:
linearity, normality

## define buffer zone

We will calculate the spatial autocorrelation between the different HSD points, to be able to see whether there is a big variation at a distance of 10 m from the auger point.

-> ask Stéphan how to do this best


## further analysis
```{r create Auger dataframe}

Auger <- dataAuger2022 %>%
  select(c("sondage_N", "arbre_plus_proche", "topo", "depth_sup", "Texture_2023"))

#create new texture variable that contains some non-corrected textures
Auger$final_texture <- ifelse(
  is.na(dataAuger2022$Texture_2023) & !(dataAuger2022$sondage_N %in% c("15.1", "15.2", "15.5", "15.7", "19.5", "19.7", "20.5")),
  dataAuger2022$texture,
  dataAuger2022$Texture_2023
)

#create new column with textures divided in three classes based upon their presence of silt
Auger$Silt_class <- ifelse(Auger$final_texture == "NA", NA, ifelse(
  Auger$final_texture %in% c("A", "Alo", "AS"), "low", ifelse(Auger$final_texture %in% c("SL", "SA", "S"), "intermediate", "high")))


Auger <- Auger %>% 
  select(c("sondage_N", "arbre_plus_proche", "topo", "depth_sup", "Silt_class", "final_texture")) %>%
  na.omit()

```

!There are multiple DBH measurements because some trees have multiple stems! => only keep biggest one


```{r define silt appearance depth for every auger point and merge with botany data}

#creata dataframe in which for every Auger point you have defined depth at which silt concentration becomes high (or if no high it is 100 because consider it as "usefull soil for tree)

Auger <- Auger %>% 
  group_by(sondage_N) %>%  #group by Auger
  mutate(depth = ifelse(any(Silt_class == "high"), 
                         min(depth_sup[Silt_class == "high"]), 
                         100) ) %>%
  left_join(Botany, by = c("arbre_plus_proche" = "TreeID")) %>%
  group_by(sondage_N) %>%
  filter(DBH == max(DBH)) %>%
  distinct(sondage_N, .keep_all = TRUE) %>%
  select(c("sondage_N", "arbre_plus_proche", "topo", "depth", "DBH", "Family", "Genus", "species", "Xutm", "Yutm"))
  
```

Points are grouped by distance from center point (arbre_plus_proche)

```{r create good buffer dataframe}
#write_csv(Auger_test, "Em_auger.csv")
#import data in Qgis

Buffer_points <- read.csv("Em_bufferpoints.csv")


AGB_buffer <- Buffer_points %>%
  group_by(sondage_N) %>%
  mutate(full_species = paste(Genus, species, sep = " ")) %>%
  summarise(amount_trees = n(),
            sp_richness = n_distinct(full_species)
            ) %>%
  merge(Elevation, by.x = 'sondage_N', by.y = 'sondage_N') %>%
  select(c("sondage_N", "sp_richness", "amount_trees", "Elevation_Paracou_depth1"))

AGB_buffer <- AGB_buffer %>% rename_at('Elevation_Paracou_depth1', ~'elevation')

Final <- Auger %>%
  merge(AGB_buffer, by.x = 'sondage_N', by.y = 'sondage_N' )

```


## data visualisation

```{r quick plots}
plot(Final$depth, Final$amount_trees)
plot(Final$depth, Final$sp_richness)
plot(Final$depth, Final$DBH)
```


## test if there is an effect of the depth of the silt horizon appearance on the number of trees

it might be interesting to look at type1 test because then you can put importance to your first variables that you put in

```{r aboveground biomass}
M0 <- lm(Final$amount_trees ~ 1)
M4 <- lm(Final$amount_trees ~ Final$elevation*Final$depth)
M3 <- lm(Final$amount_trees ~ Final$elevation + Final$depth)
M1 <- lm(Final$amount_trees ~ Final$elevation)
M2 <- lm(Final$amount_trees ~ Final$depth)


Anova(M0,M3)  #is there a difference by adding both depth and elevaiton in model
Anova(M1, M3)   #significant effect of adding depth to model with only elevation



vif(M3)
summary(M3)

vif(M4)
summary(M4)

Anova(M0, M1)  #significant effect of adding elevation
Anova(M1, M2)  #significant effect of adding depth to model with only elevation
Anova(M0, M2)  #significant effect of depth on model with nothing
Anova(M3, M4)
Anova(M3, M2)  #how interpreting this again?

autoplot(M3)  #assumptions do not seem to be completed

summary(M2)
#what does a significant intercept mean??
```



```{r DBH}

M0 <- lm(Final$DBH ~ 1)
M4 <- lm(Final$DBH ~ Final$elevation*Final$depth)
M3 <- lm(Final$DBH ~ Final$elevation + Final$depth)
M1 <- lm(Final$DBH ~ Final$elevation)
M2 <- lm(Final$DBH ~ Final$depth)


Anova(M0, M1)    #significant effect of adding elevation
Anova(M1, M2)    #significant effect of adding depth to model with only elevation (depth explains also things)
Anova(M0, M2)   #significant effect of adding depth to model with nothing
Anova(M0, M3) 
Anova(M3, M4)   #confused with interpretation

autoplot(M1)   #assumptions do not seem to be completed??
summary(M3) #how come here then no significance?



autoplot(M3)
shapiro.test(Final$elevation)
```



```{r species richness}

M4 <- lm(Final$sp_richness ~ Final$elevation*Final$depth)
autoplot(M4)
```




